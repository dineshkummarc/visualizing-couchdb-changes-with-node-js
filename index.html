<!DOCTYPE html>
<html>
<head>
  <title>CouchDB Changes</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/config.json"></script>

  <style>
    body
      { font-family: 'Helvetica', sans-serif; font-size: 86%; }
    #changes
      { border: 1px solid #ccc;
        height: 300px;
        overflow: hidden;
        position: relative; }
    #changes-container
      { width: 100%;
        height: 100%;
        overflow: hidden;
        position: absolute; }
    #changes .period
      { background: url('bg.png');
        float: right;
        width: 16px; height: 100%;
        margin: 0 0 0 2px; }
    #changes .period .inner
      { position:absolute;
        width: 16px;
        height: 300px; }
    #changes .period .counter
      { color: #666;
        background-color: rgba(236, 236, 236, 0.75);
        text-shadow: 0px 1px 0px #fff;
        font-size: 70%;
        text-align: center;
        width: 100%;
        z-index: 900;
        position: absolute; }
    #changes .period p
      { background-color: #0091e5;
        margin: 0 0px 0 4px;
        padding: 0;
        width: 16px;
        height: 2px;
        border: none;
        position: absolute;
        bottom: 0;
        right: 0; }
    #changes .period p.hide
      { display: none; }

    button
      { color: #487996;
        border: 1px solid #8ac4e5;
        background-color: #e0f4ff;
        border-radius: 4px; }
  </style>

</head>
<body>
  <div id="changes">
    <div id="changes-container">
      <div class="period" data-counter=0>
        <div class="inner">
          <div class="counter">0</div>
          <p title="" class="hide"></p>
        </div>
      </div>
    </div>
  </div>

  <button id="stop" name="stop">stop</button>

  <script>

    // -- Connect to websocket server -----------------------------------------

    var socket = new io.Socket(null, {port: config.app.port});
    socket.connect();


    // -- Setup variables and onload handler ----------------------------------

    var db,
        period = 1000,
        shift_offset = -1,
        container  = null;

    $(function() {
      shift_offset = $('#changes-container .period').first().width(),
      container = $('#changes-container');
      container.css( { width : container.parent().width() + ( shift_offset * 2 ),
                       left  : -(shift_offset*2) });
    });

    // -- Period object -------------------------------------------------------
    var Period = function() {

      Period.current = function() { return $('#changes-container .period:nth-child(2)').first() };

      var pusher  = $('#changes-container .period:first');   // Get reference to the first, hidden "pusher" interval element
          current = pusher.clone();                          // Clone this element as current interval element ...

      pusher.after(current);                                 // ... and insert it after "pusher"

      // Change the width of the "pusher" element, so it "pushes" the intervals to the left
      pusher.css({ width: 0 }).animate({ width: shift_offset + 'px' });

      // Remove the elements falling off the container on the left
      var last = $('#changes-container .period:last');
      if ( last.offset().left < 0) { last.remove() };

      return this;
    };

    // -- Change object -------------------------------------------------------

    var Change = function(id, doc) {
      var self = this;
      this.id  = id;
      this.url = function() { return 'http://' + db.client.host + ':' + [db.client.port, db.name, this.id].join('/') };
      this.position = function() { return Period.current().data('counter')*3+'px' };

      // Build element for representing the change
      var glyph = $('#changes-container .period:first p').clone().
                                                        removeClass('hide').
                                                        css({ bottom: this.position() }).
                                                        attr('title', this.url());

      // Update the counter for current period
      Period.current().data('counter', Period.current().data('counter')+1);

      // Attach events
      glyph.click(function() {document.location.href=self.url()});

      // Insert element into DOM
      Period.current().find('.inner').append(glyph);

      // Update numeric representation of the counter for current period
      Period.current().find('.counter').text(Period.current().data('counter'));

      return this;
    };

    // -- Looper --------------------------------------------------------------

    var looper = setInterval( function() { new Period(); }, period);


    // -- Attach GUI events ---------------------------------------------------

    $('#stop').click(function() {
      clearInterval(looper);
      socket.disconnect();
    });

    // -- Attach socket.io events ---------------------------------------------

    socket.on('connect', function() {
      // console.log('Connected to:', socket.host)
    });

    socket.on('message', function(message) {
      // console.log('Received message:', message)
      if (message.client) {
        db = message;
        $('body').append( $('<p>Changes in database <strong>' +
                            'http://'+db.client.host+':'+db.client.port+'/'+db.name +
                            '</strong></p>') );
      };
      if (message.id) {
        new Change(message.id);
      };
    });
  </script>

</body>
</html>
